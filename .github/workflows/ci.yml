name: CI

on:
  push:
    branches: [ "main", "server", "apispec" ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pytest coverage ruff requests

      - name: Lint (PEP8-ish)
        run: |
          ruff check .

      - name: Tests + Coverage (100% branch)
        run: |
          coverage run --branch --source=app --omit=app/server.py -m pytest
          coverage report --fail-under=100 -m

      - name: Start server (background)
        run: |
          python -m app.server &
          echo $! > server.pid

      - name: Wait for server
        run: |
          python - <<'PY'
          import socket, time
          host, port = "127.0.0.1", 8008
          deadline = time.time() + 10
          while time.time() < deadline:
              try:
                  with socket.create_connection((host, port), timeout=1):
                      print("Server is up")
                      raise SystemExit(0)
              except OSError:
                  time.sleep(0.2)
          raise SystemExit("Server did not start in time")
          PY

      - name: API tests
        run: |
          pytest -q tests_api

      - name: Stop server
        if: always()
        run: |
          kill $(cat server.pid) || true
          
          pytest -q tests_api
